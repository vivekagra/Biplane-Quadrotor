# -*- coding: utf-8 -*-
"""
Created on Sun Oct  4 21:01:50 2020

@author: Ayush Gupta
"""

function [des_state] = time_traj_backtrans(t,s)
%back transition
global backt_t cruise_t backt_x backt_y backt_z flag
%coeffz=[0;0;-0.109843663829308;1.36328673366340;-0.00780883282265320;0.198981019691118;-1.79965315857732;6.14591320573219;0.00603478742166282;0.0717173441721006;-1.46229827843710;5.94831254992451;0.217480573998250;-1.67558255005369;3.34973446504707;1.53179530090796;0.624743349214792;-4.25103244528896;8.77840913627633;-2.28234838057378;0.867532726711416;-5.48525734939893;10.8695618087061;-3.46322658505200;0.618242419582418;-4.41867866247790;9.34910801847654;-2.74103266379506;-0.101385321884923;-1.76864941903871;6.09818864719690;-1.41245426734383;-2.40012354599336;5.53662257688671;-1.63943925619426;1.31906997147912;-3.03592767059509;7.43748380653514;-3.52559687670796;1.94055533086675;-1.98758416071829;4.94534126745626;-1.55734159654031;1.42431986780663;0.862463489605581;-1.41274172912803;3.16784770021488;0.254502715177869;6.65744641996577;-13.3646993548890;11.3826437082099;-1.62707384251657;9.60797858967002;-18.8592434973301;14.7882877181088;-2.32958083830616;12.3830974756495;-23.5901258509786;17.4689604171774;-2.83429196076303;18.9433194880723;-34.2954828645898;23.2879149040722;-3.88778592677242;20.5326164708258;-36.4834057878557;24.2718689496596;-4.03129129320149;19.8481602942847;-35.1376398474234;23.4440565222049;-3.86825313119470;17.4771495155164;-31.4747212892989;21.5751693955118;-3.55284268643547;13.1887165359646;-25.4401080444193;18.7546629888111;-3.11481471694508;7.23731040156323;-17.5995148279466;15.3187543297721;-2.61388558809415;-1.63300195565983;-6.63104342287027;10.8023723200872;-1.99458790532798;-25.2555102284409;20.6940001063680;0.267952873183519;-0.641030238963914;-29.3217913854923;25.4392207566623;-1.57047746271753;-0.404453496748531;-32.5684225104256;29.1027350419270;-2.94136706159041;-0.234223145032862;-35.5374490033837;32.3130554400537;-4.09277294866676;-0.0971587065410964;-36.7289413025242;33.6523099472921;-4.58475070178521;-0.0378216597125740;-36.0899267759745;33.1908954270952;-4.48299916618525;-0.0440595642341242;-36.1256080624108;33.3012842783341;-4.53948602723919;-0.0360850673851738;-605.227692111241;526.678488883735;-147.115584924543;13.6977908298740];
%coeffx=[0;20;0.146033035285287;-1.63174708430893;0.00504378213747520;19.9103003652519;0.586817481207063;-1.99458500319135;0.0397788997014595;19.5361619792150;1.89266454470920;-3.45279057734730;0.0700585300504322;19.3593059069695;2.17191657086991;-3.51283962514430;-0.0194039685857006;20.0393877053523;0.500339846648942;-2.17317406821108;-0.164805927879056;20.9372573768150;-1.28401999561222;-1.02015162168731;-0.103551342125131;20.8749622580067;-1.46846560266325;-0.807909736221984;0.218340374682228;19.9230964997092;-0.573378824822728;-1.06755437132347;-1.15769622053614;24.4702361479633;-5.57003589660937;0.758649842909823;0.161169756042559;21.0047540878033;-2.54677617080013;-0.116525086572390;2.02727937566851;16.5366345529524;1.01040430723561;-1.05790126226783;3.98747391810207;12.2947438089032;4.06061179285955;-1.78642045066221;6.56700444523131;7.13104268974238;7.49871084168020;-2.54765452000916;5.59626750381196;9.26901369707603;5.95248535144467;-2.17930463762328;4.09378266864313;12.2168681316333;4.03845221507219;-1.76757511667285;1.94702028362691;16.0367819741873;1.78040646079025;-1.32398825840009;-4.08892597143893;25.7455287828981;-3.42226786648137;-0.395136946948930;-10.9283420533752;36.0653007626656;-8.61059651527772;0.474019244848761;-17.5835279508116;45.5400265050975;-13.1052422853627;1.18450017999994;-23.4097377600530;53.4006241593081;-16.6390423095467;1.71386051407950;-27.6532852533827;58.8572986116375;-18.9767298066631;2.04752795582832;-29.3344488542100;60.9673888320424;-19.8576612825634;2.16988066934820;-24.7683091463567;55.8314787119014;-17.9325581456389;1.92941374415196;-18.7061040913139;49.2458971367171;-15.5479342204706;1.64160253307134;-12.1417271671319;42.3879110611363;-13.1597083111400;1.36437911501807;-6.82432397179820;37.0499802081988;-11.3735343399314;1.16515035779050;1.90447177314158;28.6345398713732;-8.66911260585072;0.875451337831409;15.8250673549193;15.6754810533774;-4.64779999386245;0.459501517184414;27.7069088580838;4.99012257740474;-1.44468858262354;0.139440631540210;32.9542014537420;0.412036470670927;-0.113334409903441;0.0103887182109825];

x_traj=[0,2.38597331675099,4.76327883056461,7.11787295131181,9.42371246720014,11.6539316852650,13.7935512146162,15.8384171924931,17.7868363178738,19.6382753072781,21.4021024736247,23.0825781006976,24.6745228864590,26.1646384686228,27.5336516692053,28.7639388644962,29.8414274871758,30.7568859454312,31.5093045952769,32.1058821500225,32.5605328161831,32.8920831989260,33.1223368532156,33.2737999462265,33.3667192931828,33.4181515231954,33.4422744470281,33.4509707385113,33.4530751997236,33.4533727420632,33.4534154533811];
xdot_traj=[20,19.9651428066503,19.8495625864827,19.5637394385614,19.0315911788027,18.3154375783683,17.5295801937951,16.7304116484158,15.9094550433266,15.1310522006471,14.4286375869782,13.7206934133307,12.9345060329967,12.0032184046906,10.9101026457149,9.68406476759729,8.35554958769348,6.98170267520354,5.63541600268655,4.37995831043730,3.26429139193646,2.32157664146686,1.56832321621931,0.997640085375858,0.583044555184251,0.298377491579372,0.122509580198732,0.0357051378945963,0.00610866758051942,0.000863772108038103,0];
z_traj=[0,0.000752491947445942,0.0207227985352569,0.117220311691834,0.347493048312135,0.728688822115982,1.24121671920434,1.85311590109651,2.53902555082981,3.28926297155410,4.11656455832588,5.04214957202982,6.08282744205802,7.24354358693208,8.51352421324542,9.87344305512527,11.2979223776270,12.7534769781798,14.2041720839184,15.6154969668206,16.9560283006898,18.1985241525139,19.3206672552789,20.3071519145573,21.1529010215005,21.8565441626441,22.4180156731580,22.8381245699728,23.1178232802634,23.2576110001197,23.2809071489711];
zdot_traj=[0,0.0320254058771507,0.390193005462824,1.31179036575671,2.56934268828760,3.78691164193531,4.75362349610895,5.46263653178729,6.01294194531901,6.57965371784700,7.31337037496567,8.21951056802103,9.22564221171408,10.2045307438044,11.0468864921470,11.7046878280741,12.1139034981511,12.2234589638159,12.0347811868737,11.5681144118093,10.8545348378324,9.93219509353386,8.84626873231681,7.67786515818471,6.49094128241876,5.29862508277265,4.11012838178359,2.93026425250541,1.75679620168332,0.585500878231517,0];
theta_traj=[1.53981563004420,1.52395790703718,1.44201858781302,1.32537638936954,1.22329943014524,1.15494754957269,1.11043955429783,1.06908490887312,1.01511449380528,0.943410886918388,0.857872138815017,0.766311501408025,0.675151630746530,0.586962897898889,0.500192265141603,0.411953981924149,0.324560268581015,0.239700561121084,0.158682982797800,0.0826911572957277,0.0128746865942299,-0.0496321921552020,-0.103788767884228,-0.150038428858443,-0.189667964102752,-0.219621710981012,-0.214662001910547,-0.164220441960244,-0.0841813670592084,-0.0139763029658484,0];
thetadot_traj=[0,-0.386730325817048,-0.913373259274887,-0.968144634301199,-0.715987120179151,-0.445584712552279,-0.331007638387747,-0.384512141210824,-0.526634127025151,-0.668654300261074,-0.752973881472949,-0.771901742158880,-0.751908363202512,-0.727986303507114,-0.732685819094410,-0.739650459839495,-0.723188763553012,-0.696560236413767,-0.659247671620868,-0.612258875624565,-0.556019068614359,-0.489082476202781,-0.419438748625628,-0.356284834434873,-0.313759299649662,-0.137825515121045,0.236938361685391,0.583016791308546,0.710317019821320,0.351222913654950,0];
Tfwd_traj=[5.98844659608103,0.000113397728577547,0.000128290446336389,0.000155486069641302,0.000195253081402516,0.000248193281622270,0.000336197223438864,0.000607801927815657,1.71287139997031,29.7999784716279,57.5756131642081,79.8113620352297,93.4143678885293,92.1084743054189,88.3659580099557,82.7087716023624,69.6461829817911,56.3143792712323,43.5697328976866,31.3048518657669,19.6876092610040,8.88587660950862,0.0117440038941715,0.00135356765251124,0.000719047577398532,0.000521037772366651,0.000384763825186453,0.000250936581097583,0.000170306364728763,0.000135618837798076,117.720000000000];
Mfwd_traj=[-9.46045982909084,-23.5439835062450,-23.5439825754140,-23.5439821336394,-23.5439836463372,-23.5439867974715,-23.5439897112885,-23.5439914375114,-23.5439918921081,-23.5439909582190,-23.5439879155020,-23.5439810321984,-23.5439712383945,-23.5439644627919,-23.5438620389043,-21.9524027048423,-20.4421127615267,-18.4656109253881,-16.2301372202376,-13.7904566292575,-11.2847885801231,-8.71550939657389,-6.59358924005329,-4.68478051214095,-3.62866741328917,2.90416355685585,5.75900554487708,4.08397588881912,-0.345946939615400,-11.9537354879419,0];
Tf=3.58;
coeffx=traj_gen(x_traj,xdot_traj);
coeffz=traj_gen(z_traj,zdot_traj);

t1=norm(t-cruise_t);
t1
Tm=isempty(s);
if (t1>(Tf) && Tm==0)
    flag=5;
    backt_t=t;
    backt_z=s.pos(3);
    backt_x=s.pos(1);
    backt_y=s.pos(2);
end
if t1>3.58
    t1=3.58;
end
time=[1;t1;t1^2;t1^3];        % for cubic spline
n=4;

%Tf = 3.580993433738394
h=Tf/30;
if t1==0
    j=1;
else
    j=ceil(t1/h);
end

x = (coeffx((1:4)+n*(j-1)))'*time;
xdot=(coeffx((2:4)+n*(j-1)))'*[1;2*t1;3*t1^2];
xddot=(coeffx((3:4)+n*(j-1)))'*[2;6*t1];

time_new=t1;

theta_lim=[theta_traj(j) theta_traj(j+1)];      %linear interpol of theta
time_lim=[(j-1) j]*h;
thetad=interp1(time_lim, theta_lim, time_new);
phid=0;
psid=0;

thetadot_lim=[thetadot_traj(j) thetadot_traj(j+1)];      %linear interpol of thetadot
thetadot_des=interp1(time_lim, thetadot_lim, time_new);
phidot_des=0;
psidot_des=0;

Tfwd_lim=[Tfwd_traj(j) Tfwd_traj(j+1)];      %linear interpol of feed forward thrust
Tfwd=interp1(time_lim, Tfwd_lim, time_new);

Mfwd_lim=[Mfwd_traj(j) Mfwd_traj(j+1)];      %linear interpol of feed forward thrust
Mfwd=interp1(time_lim, Mfwd_lim, time_new);

z = (coeffz((1:4)+n*(j-1)))'*time;
zdot=(coeffz((2:4)+n*(j-1)))'*[1;2*t1;3*t1^2];
zddot=(coeffz((3:4)+n*(j-1)))'*[2;6*t1];
y=0;
ydot=0;
yddot=0;

des_state.pos = [x; y; z];
des_state.vel = [xdot; ydot; zdot];
des_state.acc = [xddot; yddot; zddot];
des_state.rot=[phid; thetad; psid];
des_state.omega=[phidot_des; thetadot_des; psidot_des];
des_state.control=[Tfwd; Mfwd];

end